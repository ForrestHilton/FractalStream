viewers:
  - title: Standard spider
    style: complex-plane
    size: 512x512
    resizable: false
    z-coord: z
    initial-center: 0
    iteration-limit: max_iters
    initial-pixel-size: 1/128
    code: "color <- white"

    tools:
      - name: Draw standard spider
        shortcut: s
        refresh-can-update: true
        actions:
          - event: refresh
            code: |
              # Save p and q to restore later, so we can manipulate
              # them in the script without changing the user's input
              savedP : Z <- p
              savedQ : Z <- q

              h2 : Z <- p
              h1 : Z <- p + q
              p <- 2 p
              q <- 2 q

              erase
              use grey for line
              draw circle at 0 with radius 1

              star1 : C <- e^{2 pi i h1 / q}
              star2 : C <- e^{2 pi i h2 / q}
              draw line from star1 to star2
              use red for line
              write "A" at i star2 / 2
              write "B" at -i star2 / 2
              use black for line

              # Brent's cycle detection algorithm
              power : Z <- 1
              λ <- 1
              tortoise : Z <- p
              hare : Z <- mod (2 p, q)
              while tortoise != hare:
                if power = λ:
                  tortoise <- hare
                  power <- 2 power
                  λ <- 0
                hare <- mod (2 hare, q)
                λ <- λ + 1

              tortoise <- p
              hare <- p
              iterate hare -> mod (2 hare, q) while true up to λ times
              μ <- 0
              while tortoise != hare:
                tortoise <- mod (2 tortoise, q)
                hare <- mod (2 hare, q)
                μ <- μ + 1

              # Now λ tells us the length of the periodic part,
              # and μ tells us the length of the preperiodic part.
              delta : R <- 1 / (λ + μ)
              ci : R <- 0

              t : Z <- p

              # We'll track the kneading sequence in a computing-friendly
              # form here, while also accumulating a human-friendly form
              # into `kneading_seq`
              iters : List of Z <- []
              S1 : Z <- 0
              S2 : Z <- 1
              A  : Z <- 2
              B  : Z <- 3

              kneading_seq <- ""

              t <- p
              while true up to μ times:
                omega : C <- e^{2 pi i t / q}
                c : Color <- rainbow(ci)
                ci <- ci + delta
                use dark c for line
                use light c for fill

                if t = h1:
                  iters <- append(iters, S1)
                  kneading_seq <- text (kneading_seq, "★₁")
                else if t = h2:
                  iters <- append(iters, S2)
                  kneading_seq <- text (kneading_seq, "★₂")
                else if re (i star2 bar(omega)) > 0:
                  iters <- append(iters, A)
                  kneading_seq <- text (kneading_seq, "A")
                else:
                  iters <- append(iters, B)
                  kneading_seq <- text (kneading_seq, "B")

                draw line from omega to 10 omega
                draw filled circle at omega with radius foot
                t <- mod (2 t, q)

              kneading_seq <- text (kneading_seq, "[")

              while true up to λ times:
                omega : C <- e^{2 pi i t / q}
                if t = h1:
                  iters <- append(iters, S1)
                  kneading_seq <- text (kneading_seq, "★₁")
                else if t = h2:
                  iters <- append(iters, S2)
                  kneading_seq <- text (kneading_seq, "★₂")
                else if re (i star2 bar(omega)) > 0:
                  iters <- append(iters, A)
                  kneading_seq <- text (kneading_seq, "A")
                else:
                  iters <- append(iters, B)
                  kneading_seq <- text (kneading_seq, "B")

                c : Color <- rainbow(ci)
                ci <- ci + delta
                use dark c for line
                use light c for fill

                draw line from omega to 10 omega
                draw filled circle at omega with radius foot
                t <- mod (2 t, q)

              kneading_seq <- text (kneading_seq, "]")

              p <- savedP
              q <- savedQ

  - title: Iterated spider
    style: complex-plane
    size: 512x512
    resizable: false
    z-coord: z
    initial-center: 0
    iteration-limit: max_iters
    initial-pixel-size: 1/128
    code: "color <- white"

    tools:
      - name: Reset
        shortcut: r
        actions:
          - event: activated
            code: |
              erase
              next_leg : Z <- 0
              spider : List of List of Z <- []
              R : R <- 5

              # Find the linear transformation that moves the first
              # foot of the standard spider to -2 and the second foot
              # to 0.
              f0 : C <- e^{2 pi i p / q}
              f1 : C <- e^{4 pi i p / q}

              # z -> -2 (z - f1) / (f0 - f1)
              m : C <- -2 / (f0 - f1)
              b : C <- 2 f1 / (f0 - f1)

              # Subdivide the legs of the standard spider, then twist
              omega : C <- e^{2 pi i p / q}

              delta : R <- 1 / (λ + μ)
              ci : R <- 0

              leg : Z <- 0
              leg1 : List of C <- []

              while true up to μ + λ times:
                z <- m omega + b

                c : Color <- rainbow(ci)
                ci <- ci + delta
                use dark c for line
                use light c for fill

                # Make a curve from R omega to z
                t : R <- 0
                dt : R <- 1 / 100
                last_gamma : C <- R omega
                draw line from 20 omega to last_gamma
                while true up to 100 times:
                  t <- t + dt
                  mt : C <- m^t
                  bt : C <- b t
                  gamma : C <- mt R^{1 - t} omega + bt
                  if leg = 1:
                    leg1 <- prepend(leg1, gamma)
                  draw line from last_gamma to gamma
                  last_gamma <- gamma

                draw filled circle at z with radius foot
                omega <- omega^2
                leg <- leg + 1

              # Reset omega
              omega <- e^{2 pi i p / q}

              z2 : C <- m omega^3 + b
              # P(z) = z2 (1 + z/2)^2
              # -2 +/- 2 sqrt (w / z2)
              last_gamma : C <- -2
              use light grey for line
              last_pre : C <- -2 + 2 sqrt(last_gamma / z2)
              for each pt in leg1:
                pre : C <- -2 + 2 sqrt(pt / z2)
                draw line from last_pre to pre
                last_pre <- pre
              last_pre <- -2 - 2 sqrt(last_gamma / z2)
              for each pt in leg1:
                pre1 : C <- -2 + 2 sqrt(pt / z2)
                pre2 : C <- -2 - 2 sqrt(pt / z2)
                pre : C <- if |pre1 - last_pre| < |pre2 - last_pre| then pre1 else pre2
                draw line from last_pre to pre
                last_pre <- pre


configuration:
  title: Configuration
  size: 400x200
  hidden:
    - name: next_leg
      type: Z
      value: "0"
    - name: spider
      type: List of (List of C)
      value: "[]"
  vertical-contents:
    - panel:
        title: "Input θ = p / q for S_θ"
        vertical-contents:
          - horizontal-contents:
              - text-entry:
                  label: ""
                  value: "9"
                  type: Z
                  variable: "p"
              - text: /
              - text-entry:
                  label: ""
                  value: "56"
                  type: Z
                  variable: "q"
    - panel:
        title: "Computed values"
        vertical-contents:
          - text-entry:
              label: "Kneading sequence"
              value: "42"
              type: Text
              variable: kneading_seq
          - horizontal-contents:
              - text-entry:
                  label: Preperiod
                  value: "0"
                  type: Z
                  variable: μ
              - text-entry:
                  label: Period
                  value: "0"
                  type: Z
                  variable: λ

    - text-entry:
        label: "Max. iterations:"
        value: "1000"
        type: Z
        variable: max_iters
    - text-entry:
        label: "Foot radius:"
        value: "0.03"
        type: R
        variable: foot
